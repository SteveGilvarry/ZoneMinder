name: build-native-packages-signed

on:
  push:
    # Allow fork testing by triggering on any branch. If you want to limit, use
    # a prefix like "build-native-packages/**" instead of "**".
    branches:
      - "**"
  workflow_dispatch:
permissions:
  contents: write
env:
  GPG_KEY_ID: ${{ secrets.ZMREPO_GPG_KEY_ID }}
  GPG_PASSPHRASE: ${{ secrets.ZMREPO_GPG_PASSPHRASE }}
  GPG_PRIVATE_KEY_B64: ${{ secrets.ZMREPO_GPG_PRIVATE_KEY_B64 }}
  DEBEMAIL: "info@zoneminder.com"
  DEBFULLNAME: "Github CI"
  TZ: America/New_York
  DEBIAN_FRONTEND: noninteractive
  DEBSIGN_KEYID: ${{ secrets.ZMREPO_GPG_KEY_ID }}
  # Signing is only enabled on the main repo when secrets are present. Forks
  # will build with a throwaway key to exercise the pipeline without deploying.
  SIGNING_ENABLED: ${{ github.repository == 'ZoneMinder/zoneminder' && secrets.ZMREPO_GPG_PRIVATE_KEY != '' }}

jobs:
  build-debian:
    name: Build & sign .deb (${{ matrix.distro }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: 
        distro: ["debian:13", "debian:12", "ubuntu:22.04", "ubuntu:24.04"]
    container:
      image: ${{ matrix.distro }}

    steps:
      - name: Prep apt
        run: |
          set -eux
          if grep -q '^deb http' /etc/apt/sources.list && ! grep -q '^deb-src'\
            /etc/apt/sources.list; then
            sed -n 's/^deb /deb-src /p' /etc/apt/sources.list >> \
              /etc/apt/sources.list
          fi
          if [ -f /etc/apt/sources.list.d/debian.sources ]; then
            sed -i 's/^Types: deb$/Types: deb deb-src/g' \
            /etc/apt/sources.list.d/debian.sources
          fi
          if [ -f /etc/apt/sources.list.d/ubuntu.sources ]; then
            sed -i 's/^Types: deb$/Types: deb deb-src/g' \
            /etc/apt/sources.list.d/ubuntu.sources
          fi
          apt-get update
      - name: Install build tools
        run: |
          set -eux
          apt install -y --no-install-recommends \
            git ca-certificates gnupg lsb-release \
            build-essential devscripts debhelper equivs fakeroot \
            cmake pkg-config ccache curl bash rsync openssh-client
          apt install -y debhelper sphinx-doc dh-linktree dh-apache2 cmake \
            libavcodec-dev libavdevice-dev libavformat-dev libavutil-dev \
            libswresample-dev libswscale-dev libbz2-dev \
            libturbojpeg0-dev default-libmysqlclient-dev \
            libpolkit-gobject-1-dev libv4l-dev libvlc-dev libssl-dev \
            libvncserver-dev libjwt-gnutls-dev libgsoap-dev gsoap \
            libmosquittopp-dev

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate throwaway GPG key (fork testing)
        if: env.SIGNING_ENABLED == 'false'
        run: |
          set -eux
          cat >gen-key.cfg <<'EOF'
          %no-protection
          Key-Type: RSA
          Key-Length: 3072
          Subkey-Type: RSA
          Subkey-Length: 3072
          Name-Real: GitHub CI Test Key
          Name-Email: ci@example.com
          Expire-Date: 2d
          EOF
          gpg --batch --generate-key gen-key.cfg
          KEY_ID=$(gpg --list-secret-keys --with-colons | awk -F: '/^sec/ {print $5; exit}')
          echo "GPG_KEY_ID=${KEY_ID}" >> "$GITHUB_ENV"
          echo "DEBSIGN_KEYID=${KEY_ID}" >> "$GITHUB_ENV"
          echo "GPG_PASSPHRASE=" >> "$GITHUB_ENV"

      - name: Import GPG key
        if: env.SIGNING_ENABLED == 'true'
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.ZMREPO_GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.ZMREPO_GPG_PASSPHRASE }}
          git_user_signingkey: false
          git_commit_gpgsign: false

      - name: Install build-deps from debian/control
        run: |
          set -eux
          ln -sf distros/ubuntu2004 debian
          mk-build-deps -ir -t "apt-get -y --no-install-recommends" \
            debian/control
      - name: Build (signed)
        env:
          DEB_BUILD_OPTIONS: "parallel=$(nproc)"
          # gpg picks passphrase from environment via loopback
        run: |
          cd ../
          ls -l
          ln -sf zoneminder ZoneMinder_ZoneMinder.git
          #git config --global --add safe.directory /__w/zoneminder/zoneminder
          #git submodule init
          #git submodule update --init --recursive
          curl -s -o do_debian_package.sh https://raw.githubusercontent.com/ZoneMinder/zoneminder/refs/heads/master/utils/do_debian_package.sh
          chmod +x do_debian_package.sh

          # Tell gpg to use loopback + passphrase
          export GPG_TTY=$(tty || true)
          ls -l /bin/bash
          ./do_debian_package.sh -s=CURRENT -t=binary 
      - name: Collect .deb artifacts (incl. signed metadata & public key)
        run: |
          set -eux
          mkdir -p artifacts/deb
          ls -l ../
          mv ../*.deb ../*.buildinfo ../*.changes ../*.dsc ../*.tar.xz ../*.tar.gz artifacts/deb/ || true
          # quick verify signatures (non-fatal)
          gpg --verify artifacts/deb/*.changes || true
          gpg --verify artifacts/deb/*.buildinfo || true
      - name: Sanitize Artifact name
        id: prep_artifact_name
        run: |
          # Use `sed` to replace invalid characters with a hyphen
          sanitized_distro_name=$(echo -n "${{ matrix.distro }}" | sed -e 's/[;\\\/:<>"|*?]/_/g' -e 's/__*/_/g')
          echo "artifact_name=binary-${sanitized_distro_name}" >> $GITHUB_ENV

      - name: Upload .deb artifacts
        uses: actions/upload-artifact@v6
        with:
          path: artifacts/deb
          name: ${{ env.artifact_name }}
      - name: Publish to ZMREPO
        if: env.SIGNING_ENABLED == 'true'
        uses: easingthemes/ssh-deploy@main
        env: 
          SSH_PRIVATE_KEY: ${{ secrets.ZMREPO_SSH_KEY }}
          ARGS: "-rltgoDzvO"
          SOURCE: artifacts/deb/
          REMOTE_HOST: ${{ secrets.ZMREPO_HOST }}
          REMOTE_USER: ${{ secrets.ZMREPO_SSH_USER }}
          TARGET: debian/master/mini-dinstall/incoming/

  build-redhat:
    name: Build & sign .rpm (${{ matrix.distro }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Use fully qualified image names for Rocky; Alma uses official org images
        distro: [
          "fedora:41",
          "fedora:42",
          "fedora:43",
          "rockylinux/rockylinux:9",
          "rockylinux/rockylinux:10",
          "almalinux:9",
          "almalinux:10"
        ]
    container:
      image: ${{ matrix.distro }}

    steps:
      - name: Install build tools
        run: |
          set -eux
          if command -v dnf &> /dev/null; then
            PKG_MGR=dnf
          else
            PKG_MGR=yum
          fi

          if [ "$PKG_MGR" = dnf ]; then
            $PKG_MGR -y install dnf-plugins-core || true
            . /etc/os-release
            if echo "$ID" | grep -qiE 'rocky|almalinux'; then
              # Enable EPEL first (needed for rpmdevtools and other build deps)
              $PKG_MGR -y install epel-release || true
              $PKG_MGR config-manager --set-enabled crb || true
              # Enable RPM Fusion Free for ffmpeg on EL
              $PKG_MGR -y install --nogpgcheck \
                https://mirrors.rpmfusion.org/free/el/rpmfusion-free-release-$(rpm -E %rhel).noarch.rpm || true
            fi
            $PKG_MGR makecache -y || true
          fi

          # Base toolchain and common build tooling (install AFTER repos are enabled)
          $PKG_MGR install -y \
            git ca-certificates gnupg \
            rpm-build rpm-sign rpmdevtools rpmlint \
            cmake gcc gcc-c++ make \
            curl bash rsync openssh-clients \
            mariadb-connector-c-devel \
            polkit-devel \
            openssl-devel \
            gsoap-devel || true

          # Optional multimedia and integrations; try distro-appropriate names and don't fail if unavailable
          # FFmpeg binary and libs
          ($PKG_MGR install -y ffmpeg-free || $PKG_MGR install -y ffmpeg || true)
          ($PKG_MGR install -y ffmpeg-free-devel || $PKG_MGR install -y ffmpeg-devel || true)
          # JPEG Turbo
          ($PKG_MGR install -y turbojpeg-devel || $PKG_MGR install -y libjpeg-turbo-devel || true)
          # V4L2
          ($PKG_MGR install -y libv4l-devel || $PKG_MGR install -y v4l-utils-devel || true)
          # VLC (may not exist on EL; EPEL may provide)
          ($PKG_MGR install -y vlc-devel || true)
          # VNC server
          ($PKG_MGR install -y libvncserver-devel || true)
          # JWT
          ($PKG_MGR install -y libjwt-devel || true)
          # Mosquitto (MQTT)
          ($PKG_MGR install -y mosquitto-devel || true)

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate throwaway GPG key (fork testing)
        if: env.SIGNING_ENABLED == 'false'
        run: |
          set -eux
          cat >gen-key.cfg <<'EOF'
          %no-protection
          Key-Type: RSA
          Key-Length: 3072
          Subkey-Type: RSA
          Subkey-Length: 3072
          Name-Real: GitHub CI Test Key
          Name-Email: ci@example.com
          Expire-Date: 2d
          EOF
          gpg --batch --generate-key gen-key.cfg
          KEY_ID=$(gpg --list-secret-keys --with-colons | awk -F: '/^sec/ {print $5; exit}')
          echo "GPG_KEY_ID=${KEY_ID}" >> "$GITHUB_ENV"
          echo "GPG_PASSPHRASE=" >> "$GITHUB_ENV"

      - name: Import GPG key
        if: env.SIGNING_ENABLED == 'true'
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.ZMREPO_GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.ZMREPO_GPG_PASSPHRASE }}
          git_user_signingkey: false
          git_commit_gpgsign: false

      - name: Setup RPM build environment
        run: |
          set -eux
          rpmdev-setuptree
          
          # Configure GPG for RPM signing only when secrets are available
          if [ "${{ env.SIGNING_ENABLED }}" = "true" ]; then
            echo "%_signature gpg" >> ~/.rpmmacros
            echo "%_gpg_name ${{ secrets.ZMREPO_GPG_KEY_ID }}" >> ~/.rpmmacros
          fi

      - name: Build RPM
        env:
          GPG_TTY: /dev/console
        run: |
          set -eux
          
          # Fix git ownership in container
          git config --global --add safe.directory /__w/ZoneMinder/ZoneMinder
          
          # Check if there's a spec file in the repo
          # Adjust the path according to your repository structure
          if [ -f "distros/redhat/zoneminder.spec" ]; then
            SPEC_FILE="distros/redhat/zoneminder.spec"
          elif [ -f "zoneminder.spec" ]; then
            SPEC_FILE="zoneminder.spec"
          else
            echo "Error: No spec file found"
            exit 1
          fi
          
          # Install build dependencies from spec (skip unavailable packages)
          if command -v dnf &> /dev/null; then
            dnf builddep -y --skip-unavailable $SPEC_FILE || true
            # Install core deps that builddep may have skipped
            dnf install -y bzip2-devel json-devel mariadb-devel net-tools \
              perl perl-generators systemd-devel \
              gnutls-devel libcurl-devel \
              perl-Archive-Tar perl-Archive-Zip perl-DBD-MySQL \
              perl-Date-Manip perl-Expect perl-ExtUtils-MakeMaker \
              perl-LWP-Protocol-https perl-MIME-Lite perl-MIME-tools \
              perl-Net-SFTP-Foreign perl-PHP-Serialization \
              perl-Sys-Mmap perl-Time-HiRes perl-Sys-Syslog || true
          else
            yum-builddep -y --skip-broken $SPEC_FILE || true
            yum install -y bzip2-devel json-devel mariadb-devel net-tools \
              perl perl-generators systemd-devel \
              gnutls-devel libcurl-devel || true
          fi
          
          # Create source tarball
          VERSION=$(grep '^Version:' $SPEC_FILE | awk '{print $2}')
          git archive --format=tar.gz --prefix=zoneminder-$VERSION/ HEAD > ~/rpmbuild/SOURCES/zoneminder-$VERSION.tar.gz
          
          # Download additional source tarballs required by spec
          CRUD_VER=$(grep '^%global crud_version' $SPEC_FILE | awk '{print $3}')
          CEB_VER=$(grep '^%global ceb_version' $SPEC_FILE | awk '{print $3}')
          RTSP_COMMIT=$(grep '^%global rtspserver_commit' $SPEC_FILE | awk '{print $3}')
          CXXURL_VER=$(grep '^%global CxxUrl_version' $SPEC_FILE | awk '{print $3}')
          
          cd ~/rpmbuild/SOURCES
          curl -fsSL -o crud-${CRUD_VER}.tar.gz \
            https://github.com/FriendsOfCake/crud/archive/v${CRUD_VER}.tar.gz
          curl -fsSL -o cakephp-enum-behavior-${CEB_VER}.tar.gz \
            https://github.com/ZoneMinder/CakePHP-Enum-Behavior/archive/${CEB_VER}.tar.gz
          curl -fsSL -o RtspServer-${RTSP_COMMIT}.tar.gz \
            https://github.com/ZoneMinder/RtspServer/archive/${RTSP_COMMIT}.tar.gz
          curl -fsSL -o CxxUrl-${CXXURL_VER}.tar.gz \
            https://github.com/chmike/CxxUrl/archive/${CXXURL_VER}.tar.gz
          cd -
          
          # Build the RPM (toggle features per distro)
          . /etc/os-release
          RPMSPEC_OPTS="--with v4l --with mqtt --with vnc"
          if echo "$ID" | grep -qi fedora; then
            RPMSPEC_OPTS="$RPMSPEC_OPTS --with vlc"
          else
            RPMSPEC_OPTS="$RPMSPEC_OPTS --without vlc"
          fi
          rpmbuild -ba $SPEC_FILE $RPMSPEC_OPTS

      - name: Sign RPMs
        if: env.SIGNING_ENABLED == 'true'
        run: |
          set -eux
          export GPG_TTY=$(tty || true)
          
          # Sign all built RPMs
          echo "${{ secrets.ZMREPO_GPG_PASSPHRASE }}" | \
            rpm --addsign ~/rpmbuild/RPMS/*/*.rpm \
            --define "_gpg_name ${{ secrets.ZMREPO_GPG_KEY_ID }}"

      - name:  Collect . rpm artifacts
        run: |
          set -eux
          mkdir -p artifacts/rpm
          find ~/rpmbuild -name "*.rpm" -exec cp {} artifacts/rpm/ \;
          
          # Verify signatures
          rpm --checksig artifacts/rpm/*.rpm || true

      - name:  Sanitize Artifact name
        run: |
          sanitized_distro_name=$(echo -n "${{ matrix.distro }}" | sed -e 's/[;\\\/:<>"|*?]/_/g' -e 's/__*/_/g')
          echo "artifact_name=binary-${sanitized_distro_name}" >> $GITHUB_ENV

      - name: Upload .rpm artifacts
        uses: actions/upload-artifact@v6
        with:
          path: artifacts/rpm
          name: ${{ env.artifact_name }}

      - name: Publish to ZMREPO
        if: env.SIGNING_ENABLED == 'true'
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.ZMREPO_SSH_KEY }}
          ARGS: "-rltgoDzvO"
          SOURCE: artifacts/rpm/
          REMOTE_HOST: ${{ secrets.ZMREPO_HOST }}
          REMOTE_USER:  ${{ secrets.ZMREPO_SSH_USER }}
          TARGET: redhat/master/incoming/

  release:
    name: Create GitHub Release (on tag)
    needs: [build-debian, build-redhat]
    if: github.repository == 'ZoneMinder/zoneminder' && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: dist
      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/**/*
